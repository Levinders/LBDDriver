<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dispatch & Disposal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:'Inter',sans-serif;background:#f9fafb;color:#1f2937;}
    .wrap{max-width:700px;margin:50px auto;padding:20px;}
    .card{background:#fff;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,0.05);padding:36px;}
    h1{margin:0 0 8px;font-size:24px;font-weight:600;}
    .sub{color:#6b7280;font-size:14px;margin-bottom:30px;}
    .section{margin-bottom:36px;}
    .section-title{color:#DC4128;font-weight:600;border-left:4px solid #DC4128;padding-left:10px;margin-bottom:18px;font-size:17px;}
    label{display:block;font-weight:500;margin-bottom:6px;font-size:14px;}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;margin-bottom:16px;font-size:15px;}
    #dateISO {width: 90%;min-width: 180px;}   
    input:focus,select:focus{border-color:#DC4128;outline:none;box-shadow:0 0 0 3px rgba(220,65,40,0.15);}
    .sig-pad{border:2px dashed #e5e7eb;border-radius:12px;padding:20px;text-align:center;}
    #typedSignature{font-family:'Great Vibes',cursive;font-size:42px;color:#000;position:relative;display:inline-block;}
    #typedSignature svg{position:absolute;bottom:-10px;left:0;width:100%;height:20px;}
    #typedDate{font-size:13px;color:#555;margin-top:16px;}
    .btn{background:#DC4128;color:#fff;border:none;border-radius:10px;padding:12px 20px;font-weight:500;cursor:pointer;}
    .btn:hover{background:#f25c41;}
    .toast{position:fixed;bottom:20px;right:20px;background:#1f2937;color:#fff;padding:12px 20px;border-radius:8px;opacity:0;transform:translateY(20px);transition:all 0.4s ease;}
    .toast.show{opacity:1;transform:translateY(0);}


    @media (max-width: 700px) {
  .card { padding: 24px; }
  .wrap { margin: 20px auto; }
}

  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Dispatch & Disposal</h1>
      <div class="sub">Complete all fields and submit</div>

      <div class="section">
        <div class="section-title">Company & Material</div>
        <label>Company</label><select id="companyName"></select>
        <label>Material</label><select id="materialsType"></select>
        <label>Date</label><input type="date" id="dateISO" />
      </div>

      <div class="section">
        <div class="section-title">Site & Driver</div>
        <label>Job Site</label><select id="jobSite"></select>
        <label>Driver</label><select id="driver"></select>
      </div>

      <div class="section">
        <div class="section-title">Weights & Tokens</div>
        <label>Tonnage</label><input type="number" id="tonnage" />
        <label>Token (Last 4)</label><input type="text" id="tokenLast4" maxlength="4" />
        <label>To Site Token</label><select id="toSiteToken"></select>
        <label>From Site Token</label><select id="fromSiteToken"></select>
      </div>

      <div class="section">
        <div class="section-title">E-Signature</div>
        <div class="sig-pad" id="sigPad">
          <div id="typedSignature">Sample Name
            <svg><path d="M0 10 Q50 0, 120 10 T260 10" stroke="#000" stroke-width="1.2" fill="transparent"/></svg>
          </div>
          <div id="typedDate">YYYY/MM/DD</div>
        </div>
      </div>

      <button class="btn" id="submitBtn">Submit</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const scriptBaseURL = "https://corsproxy.io/?" + encodeURIComponent("https://script.google.com/macros/s/AKfycbwkwpttAGbCu5Y0an3B7pqff-ErpSX8Jo1qGPeVU5zM1q_cVRt8XCFiTD79Bc2dbKNx/exec");

    function showToast(msg){const t=document.getElementById("toast");t.textContent=msg;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),3000);}

    async function loadOptions(){
      try{
        const res=await fetch(`${scriptBaseURL}?type=getFieldOptions`,{cache:"no-store"});
        const text=await res.text();
        const data=JSON.parse(text);
        const sel=(id,arr)=>{const el=document.getElementById(id);el.innerHTML='<option value="">Select...</option>';arr.forEach(v=>el.innerHTML+=`<option>${v}</option>`);}
        sel("companyName",data.companies);sel("materialsType",data.materials);sel("jobSite",data.jobSites);sel("driver",data.drivers);sel("toSiteToken",data.toSiteTokens);sel("fromSiteToken",data.fromSiteTokens);
        showToast("✅ Options loaded successfully");
      }catch(err){console.error("Load error:",err);showToast("⚠️ Error loading options");}
    }
    loadOptions();

    document.getElementById("submitBtn").onclick=async()=>{
      const d=id=>document.getElementById(id).value;
      const payload={companyName:d("companyName"),materialsType:d("materialsType"),dateISO:d("dateISO").replace(/-/g,'/'),
      jobSite:d("jobSite"),driver:d("driver"),tonnage:d("tonnage"),tokenLast4:d("tokenLast4"),toSiteToken:d("toSiteToken"),fromSiteToken:d("fromSiteToken"),signatureDataURL:document.getElementById("sigPad").outerHTML};
      showToast("Submitting...");
      try{
        const res=await fetch(scriptBaseURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        const text=await res.text();console.log(text);
        const data=JSON.parse(text);
        showToast(data.message||"✅ Record saved!");
      }catch(err){showToast("⚠️ Submission failed");console.error(err);}
    };
  </script>
</body>
</html>
